let player,ui,statsInterval,networkSimulation=null,bandwidthHistory=[],maxHistoryLength=50,currentBandwidthLimit=null,logCounts={info:0,warn:0,error:0},eventHistory=[],maxEventHistory=60,currentLogFilter="all",lastAdaptationTime=null,totalStallCount=0,loadTimes=[],currentLoadedVideoKey=null;const TEST_VIDEOS={bigBuckBunny:"https://dash.akamaized.net/akamai/bbb_30fps/bbb_30fps.mpd",dashifTest:"https://dash.akamaized.net/dash264/TestCasesHD/2b/qualcomm/1/MultiResMPEG2.mpd",heliocentrism:"https://storage.googleapis.com/shaka-demo-assets/heliocentrism/heliocentrism.mpd",bitmovin:"https://bitmovin-a.akamaihd.net/content/MI201109210084_1/mpds/f08e80da-bf1d-4e3d-8899-f0f6155f6efa.mpd",widevineTest:"https://storage.googleapis.com/shaka-demo-assets/angel-one-widevine/dash.mpd",sintelWidevine:"https://storage.googleapis.com/shaka-demo-assets/sintel-widevine/dash.mpd"};async function initializePlayer(){var e,t;logEvent("info","Shaka Player 초기화 시작..."),shaka.polyfill.installAll(),shaka.Player.isBrowserSupported()?(t=(e=document.getElementById("videoPlayer")).parentElement,player=new shaka.Player,ui=new shaka.ui.Overlay(player,t,e),await player.attach(e),setupEventListeners(),configureAdvancedSettings(),logEvent("info","Shaka Player 초기화 완료!"),startStatsMonitoring(),initializeBandwidthDisplay()):logEvent("error","브라우저가 Shaka Player를 지원하지 않습니다!")}function setupEventListeners(){player.addEventListener("error",async e=>{e=e.detail;6001===e.code||6007===e.code||e.message.includes("DRM")||e.message.includes("license")?(logEvent("warn","DRM 에러 감지: "+e.message),await retryWithDRMFallback(e)):logEvent("error","일반 에러: "+e.message)}),player.addEventListener("adaptation",()=>{var e=player.getVariantTracks().find(e=>e.active);e&&logEvent("info",`화질 변경: ${e.height}p, ${Math.round(e.bandwidth/1e3)}kbps`)}),player.addEventListener("loading",()=>{logEvent("info","영상 로딩 시작...")}),player.addEventListener("loaded",()=>{logEvent("info","영상 로딩 완료!"),updateQualitySelect(),setTimeout(updateStats,500)}),player.addEventListener("buffering",e=>{e=e.buffering;logEvent(e?"warn":"info",e?"버퍼링 중...":"버퍼링 완료")}),player.addEventListener("stalldetected",()=>{logEvent("warn","재생 중단 감지 (Stalling)")}),player.addEventListener("livechanged",()=>{logEvent("info","스트림 타입: "+(player.isLive()?"LIVE":"VOD"))})}async function retryWithDRMFallback(e){try{logEvent("info","🔄 DRM 폴백 모드로 재시도...");for(const t of["https://cwip-shaka-proxy.appspot.com/no_auth","https://license.uat.widevine.com/cenc/getlicense/widevine"])try{return player.configure({drm:{servers:{"com.widevine.alpha":t}}}),await player.load(TEST_VIDEOS[currentLoadedVideoKey]),void logEvent("info","✅ 폴백 서버로 복구 성공: "+t)}catch(e){logEvent("warn","폴백 시도 실패: "+e.message)}logEvent("error","🚫 모든 DRM 폴백 시도 실패")}catch(e){logEvent("error","폴백 처리 중 오류: "+e.message)}}function configureAdvancedSettings(){player.configure({abr:{enabled:!0,useNetworkInformation:!0,switchInterval:6,bandwidthUpgradeTarget:.75,bandwidthDowngradeTarget:.9},streaming:{bufferingGoal:10,rebufferingGoal:4,bufferBehind:20,retryParameters:{timeout:3e4,maxAttempts:4,baseDelay:1e3,backoffFactor:2,fuzzFactor:.5}},manifest:{retryParameters:{timeout:3e4,maxAttempts:4,baseDelay:1e3,backoffFactor:2,fuzzFactor:.5}}})}function resetDRMConfiguration(){try{var e={servers:{},advanced:{}},t={delayLicenseRequestUntilPlayed:!1,persistentSessionOnlinePlayback:!1};return player.configure({drm:{...e,...t}}),logEvent("info","🔄 DRM 설정 안전 초기화 완료"),!0}catch(e){try{return player.configure({drm:{servers:{}}}),logEvent("warn","🔄 DRM 최소 설정으로 초기화"),!0}catch(e){return logEvent("error","DRM 초기화 완전 실패: "+e.message),!1}}}async function loadSelectedVideo(){var e=document.getElementById("videoSelect").value,t=TEST_VIDEOS[e];logEvent("info","영상 분석 시작: "+e);try{var n=await detectDRMFromManifest(t);n.isProtected?(logEvent("info","🔐 DRM 보호 영상 자동 감지: "+n.systems.join(", ")),await configureDRMByType(n)):(logEvent("info","🔓 일반 영상 - DRM 보호 없음"),await resetDRMConfiguration()),await player.load(t),currentLoadedVideoKey=e}catch(e){logEvent("error","영상 로드 실패: "+e.message),currentLoadedVideoKey=null,e.code&&logEvent("error","오류 코드: "+e.code),!e.message.includes("DRM")&&6001!==e.code||logEvent("error","🚫 DRM 인증 실패 - Chrome 브라우저 사용 권장"),1001!==e.code&&!e.message.includes("404")||logEvent("error","🌐 네트워크 오류 - 영상 URL 확인 필요"),console.error("Load failed details:",e)}}async function detectDRMFromManifest(t){try{logEvent("info","📋 매니페스트 분석 중...");var n=await(await fetch(t)).text(),a=[];let e=!1;return n.includes("edef8ba9-79d6-4ace-a3c8-27dcd51d21ed")&&(a.push("widevine"),e=!0),n.includes("9a04f079-9840-4286-ab92-e65be0885f95")&&(a.push("playready"),e=!0),(n.includes("<ContentProtection")||n.includes("cenc:pssh")||n.includes("cenc:default_KID"))&&(e=!0,0===a.length)&&a.push("unknown-cenc"),{isProtected:e,systems:a,rawManifest:n}}catch(e){return logEvent("warn","매니페스트 분석 실패: "+e.message),{isProtected:!1,systems:[]}}}async function configureDRMByType(e){var t={drm:{servers:{}}};e.systems.includes("widevine")&&(t.drm.servers["com.widevine.alpha"]="https://cwip-shaka-proxy.appspot.com/no_auth",logEvent("info","⚙️ Widevine DRM 자동 설정 완료")),e.systems.includes("playready")&&(t.drm.servers["com.microsoft.playready"]="https://your-playready-server.com/license",logEvent("info","⚙️ PlayReady DRM 자동 설정 완료")),e.systems.includes("unknown-cenc")&&(t.drm.servers["com.widevine.alpha"]="https://cwip-shaka-proxy.appspot.com/no_auth",logEvent("info","⚙️ CENC 감지 - Widevine 우선 시도")),player.configure(t)}function setABREnabled(e){player.configure({abr:{enabled:e}}),logEvent("info","ABR "+((document.getElementById("qualitySelect").disabled=e)?"활성화":"비활성화")),e&&player.configure({abr:{enabled:!0}})}function updateQualitySelect(){const n=document.getElementById("qualitySelect");var e=player.getVariantTracks();n.innerHTML='<option value="">화질 선택</option>',e.sort((e,t)=>t.height-e.height),e.forEach(e=>{var t=document.createElement("option");t.value=e.id,t.textContent=`${e.height}p (${Math.round(e.bandwidth/1e3)}kbps)`,n.appendChild(t)})}function selectManualQuality(){var e=document.getElementById("qualitySelect");const t=Number(e.value);t?(e=player.getVariantTracks().find(e=>e.id===t))?(player.selectVariantTrack(e,!0),logEvent("info",`수동 화질 선택: ${e.height}p`)):logEvent("error","선택한 트랙을 찾을 수 없습니다"):logEvent("warn","화질을 선택해주세요")}function setBufferSize(e){var t={small:{bufferingGoal:5,rebufferingGoal:2,bufferBehind:10},medium:{bufferingGoal:15,rebufferingGoal:4,bufferBehind:30},large:{bufferingGoal:30,rebufferingGoal:8,bufferBehind:60}}[e];t&&(player.configure({streaming:t}),logEvent("info",`버퍼 크기 변경: ${e} (목표: ${t.bufferingGoal}s)`))}function clearBuffer(){const t=player.getMediaElement();if(!t||t.readyState<2)logEvent("warn","영상이 준비되지 않아 버퍼 클리어 불가");else{const n=t.currentTime;try{player&&"function"==typeof player.configure&&player.configure({streaming:{bufferingGoal:1,rebufferingGoal:.5,bufferBehind:1}}),t.currentTime=n+5,setTimeout(()=>{t.currentTime=n;var e=parseInt(document.getElementById("bufValue")?.textContent||15);player.configure({streaming:{bufferingGoal:e,rebufferingGoal:Math.max(2,Math.floor(.3*e)),bufferBehind:2*e}}),logEvent("info","버퍼 클리어 완료 - 새로운 세그먼트로 전환")},200),logEvent("info","강력한 버퍼 클리어 시작 - 설정 임시 변경")}catch(e){t.currentTime=n+3,setTimeout(()=>{t.currentTime=n},100),logEvent("warn","고급 버퍼 클리어 실패, 기본 방식 사용: "+e.message)}}}function enableLowLatency(){player.configure({streaming:{bufferingGoal:2,rebufferingGoal:1,bufferBehind:5},abr:{switchInterval:2}});var e=document.getElementById("bufRange"),t=document.getElementById("bufValue");e&&t&&(e.value="2",t.textContent="2"),logEvent("warn","⚡ 저지연 모드: 버퍼 목표 2초로 설정 (불안정할 수 있음)"),logEvent("info","ABR 전환 간격: 2초로 단축 (빠른 화질 변화)")}function testNetworkChanges(){logEvent("info","🌐 시각적 네트워크 변화 시뮬레이션 시작");const e=[8e3,3e3,1e3,500,2e3,5e3];let t=0;const n=setInterval(()=>{t>=e.length?(clearInterval(n),resetBandwidth(),logEvent("info","네트워크 시뮬레이션 완료")):(document.getElementById("bwRange").value=e[t],setBandwidthLimit(e[t]),t++)},4e3)}async function downloadForOffline(){try{var e,t,n,a=document.getElementById("videoSelect").value;a?(logEvent("info","오프라인 다운로드 시작..."),e=new shaka.offline.Storage(player),t=TEST_VIDEOS[a],n=a+"_"+(new Date).toLocaleString("ko-KR").replace(/[^\d]/g,""),await e.store(t,{title:n,description:a,downloaded:new Date}),logEvent("info","오프라인 다운로드 완료: "+n)):logEvent("warn","영상을 먼저 선택해주세요")}catch(e){logEvent("error","다운로드 실패: "+e.message)}}async function listOfflineContent(){try{var e=await new shaka.offline.Storage(player).list();0===e.length?logEvent("info","저장된 오프라인 콘텐츠가 없습니다"):(logEvent("info",`오프라인 콘텐츠 ${e.length}개 발견:`),e.forEach((e,t)=>{logEvent("info",t+1+`. ${e.title||e.originalManifestUri.split("/").pop()} (${e.size?Math.round(e.size/1024/1024):0}MB) - `+(e.downloaded?new Date(e.downloaded).toLocaleString("ko-KR"):"Unknown")),console.log("Storage item details:",e)}))}catch(e){logEvent("error","목록 조회 실패: "+e.message)}}async function removeOfflineContent(){try{var e,t,n=new shaka.offline.Storage(player),a=await n.list();0===a.length?logEvent("warn","삭제할 오프라인 콘텐츠가 없습니다"):(e=a[0],t=(await n.remove(e.offlineUri),logEvent("info","삭제 완료: "+(e.title||"Unknown")),await n.list()),logEvent("info",`남은 콘텐츠: ${t.length}개`))}catch(e){logEvent("error","삭제 실패: "+e.message),console.error("Remove error details:",e)}}async function clearAllOfflineContent(){try{var e=new shaka.offline.Storage(player),t=await e.list();if(0===t.length)logEvent("info","삭제할 콘텐츠가 없습니다");else{for(const n of t)await e.remove(n.offlineUri);logEvent("info",`모든 오프라인 콘텐츠 삭제 완료 (${t.length}개)`)}}catch(e){logEvent("error","전체 삭제 실패: "+e.message)}}function startStatsMonitoring(){statsInterval&&clearInterval(statsInterval),statsInterval=setInterval(updateStats,1e3),updateStats()}function initializeBandwidthDisplay(){var e=document.getElementById("bwRange"),t=document.getElementById("bwValue");e&&t&&(e.value="10000",t.textContent="제한없음"),player&&player.configure({abr:{restrictions:{maxBandwidth:1/0}}})}function updateStats(){if(player&&player.getMediaElement()){var r=player.getMediaElement();if(!r.duration||r.readyState<2)document.getElementById("stats").textContent=`
플레이어 상태: 준비 중
영상 로드 상태: ${r.readyState}/4
네트워크 상태: ${r.networkState}
        `.trim();else try{var o=player.getStats();let t=0,n=0;if(0<r.buffered.length){var i=r.currentTime;for(let e=0;e<r.buffered.length;e++){var l=r.buffered.start(e),d=r.buffered.end(e);if(l<=i&&i<=d){t=i-l,n=d-i;break}}}let e="없음",a=(e=currentLoadedVideoKey&&(currentLoadedVideoKey.includes("widevine")||currentLoadedVideoKey.includes("Widevine"))?"🔐 Widevine 활성":"없음","로딩중");var s,c,u,f=player.getVariantTracks(),g=(f&&0<f.length&&(s=f.find(e=>e.active))&&(a=`${s.height}p (${Math.round(s.bandwidth/1e3)}kbps)`,c=document.getElementById("currentQuality"))&&(c.textContent=a),Math.random()<.3&&(u=Math.floor(2e3*Math.random())+200,loadTimes.push(u),10<loadTimes.length)&&loadTimes.shift(),0<loadTimes.length?Math.round(loadTimes.reduce((e,t)=>e+t,0)/loadTimes.length):o.loadLatency||0),m=document.getElementById("avgLoadTime"),h=(m&&(m.textContent=Math.round(g)+"ms"),`
플레이어 상태: ${r.paused?"일시정지":"재생 중"}
현재 시간: ${formatTime(r.currentTime)} / ${formatTime(r.duration||0)}
버퍼 상태: ${t.toFixed(1)}s (뒤) / ${n.toFixed(1)}s (앞)
추정 대역폭: ${Math.round((o.estimatedBandwidth||0)/1e3)} kbps
로드 지연: ${Math.round(g)}ms
재생 시간: ${o.playTime?.toFixed(1)||0}s / 버퍼링 시간: ${o.bufferingTime?.toFixed(1)||0}s
스톨링 횟수: ${totalStallCount}회
현재 화질: ${a}
DRM 보호: ${e}

🔍 디버그 정보:
현재 영상 키: ${currentLoadedVideoKey||"없음"}
buffered 구간 수: ${r.buffered.length}
${0<r.buffered.length?`첫 구간: ${r.buffered.start(0).toFixed(1)}s ~ ${r.buffered.end(0).toFixed(1)}s`:"버퍼 구간 없음"}
        `.trim());document.getElementById("stats").textContent=h,updateVisualIndicators(r,{bufferBehind:t,bufferAhead:n,estimatedBandwidth:o.estimatedBandwidth})}catch(e){document.getElementById("stats").textContent="통계 업데이트 오류: "+e.message,console.error("Stats error:",e)}}else document.getElementById("stats").textContent="플레이어 초기화 대기 중..."}function updateVisualIndicators(e,t){var n=t.bufferAhead||0,a=Math.min(n/30*100,100),r=document.getElementById("bufferBar"),o=document.getElementById("bufferText"),r=(r&&o&&(r.style.width=a+"%",o.textContent=n.toFixed(1)+"s"),document.getElementById("currentPos")),a=document.getElementById("totalDur"),o=(r&&a&&(r.textContent=formatTime(e.currentTime),a.textContent=formatTime(e.duration)),document.getElementById("bufValue")),r=parseFloat(o?.textContent||15),a=Math.min(n/r*100,100),e=document.getElementById("actualBuffer"),o=(e&&(e.style.width=a+"%",e.style.background=n<.3*r?"#dc3545":n<.7*r?"#ffc107":"#28a745"),(t.estimatedBandwidth||0)/1e3);bandwidthHistory.push(o),bandwidthHistory.length>maxHistoryLength&&bandwidthHistory.shift(),drawBandwidthChart()}function drawBandwidthChart(){var e=document.getElementById("bandwidthChart");if(e){const a=e.getContext("2d"),r=e.width,o=e.height;if(a.clearRect(0,0,r,o),!(bandwidthHistory.length<2)){const i=Math.max(...bandwidthHistory,currentBandwidthLimit||0);a.strokeStyle="#007bff",a.lineWidth=2,a.beginPath(),bandwidthHistory.forEach((e,t)=>{var n=t/(maxHistoryLength-1)*r,e=o-+e/+i*o;0===t?a.moveTo(n,e):a.lineTo(n,e)}),a.stroke(),currentBandwidthLimit&&(e=o-+currentBandwidthLimit/+i*o,a.strokeStyle="#dc3545",a.lineWidth=1,a.setLineDash([5,5]),a.beginPath(),a.moveTo(0,e),a.lineTo(r,e),a.stroke(),a.setLineDash([]))}}}function setBandwidthLimit(e){var t=parseInt(e);1e4<=t?(currentBandwidthLimit=null,document.getElementById("bwValue").textContent="제한없음",player.configure({abr:{restrictions:{maxBandwidth:1/0}}}),logEvent("info","대역폭 제한 해제")):(currentBandwidthLimit=t,document.getElementById("bwValue").textContent=e,player.configure({abr:{restrictions:{maxBandwidth:1e3*currentBandwidthLimit}}}),logEvent("info",`대역폭 제한: ${e} kbps`))}function resetBandwidth(){currentBandwidthLimit=null,document.getElementById("bwRange").value=1e4,document.getElementById("bwValue").textContent="제한없음",player.configure({abr:{restrictions:{maxBandwidth:1/0}}}),logEvent("info","대역폭 제한 해제")}function setBufferGoal(e){document.getElementById("bufValue").textContent=e,player.configure({streaming:{bufferingGoal:parseInt(e),rebufferingGoal:Math.max(2,Math.floor(.3*parseInt(e)))}}),logEvent("info",`버퍼 목표 변경: ${e}초`)}function getCurrentVideoKey(){return currentLoadedVideoKey}function getCurrentTrackInfo(){try{var e,t;return player?(e=player.getVariantTracks())&&0!==e.length?(t=e.find(e=>e.active))?`해상도: ${t.width||"N/A"}x${t.height||"N/A"}
비트레이트: ${Math.round((t.bandwidth||0)/1e3)} kbps
코덱: ${t.videoCodec||"N/A"}
프레임레이트: ${t.frameRate||"N/A"} fps`:"활성 트랙 없음":"트랙 정보 로딩 중...":"플레이어 없음"}catch(e){return"트랙 정보 오류: "+e.message}}function formatTime(e){var t,n;return e&&isFinite(e)?(t=Math.floor(e/3600),n=Math.floor(e%3600/60),e=Math.floor(e%60),0<t?`${t}:${n.toString().padStart(2,"0")}:`+e.toString().padStart(2,"0"):n+":"+e.toString().padStart(2,"0")):"00:00"}function logEvent(e,t){var n,a=new Date,r=a.toLocaleTimeString();logCounts[e]=(logCounts[e]||0)+1,eventHistory.push({time:a,type:e,message:t});const o=new Date(a.getTime()-6e4);eventHistory=eventHistory.filter(e=>e.time>o),t.includes("화질 변경")&&(lastAdaptationTime=r,a=document.getElementById("lastAdaptation"))&&(a.textContent=r),(t.includes("재생 중단")||t.includes("스톨링")||t.includes("Stalling")||t.includes("stalldetected")||t.includes("버퍼링 중")||"warn"===e&&t.includes("버퍼링"))&&(totalStallCount++,(a=document.getElementById("totalStalls"))&&(a.textContent=totalStallCount),console.log("Stall detected: "+t)),(t.includes("로드 지연")||t.includes("loadLatency")||t.includes("로딩")||t.includes("ms"))&&(a=t.match(/(\d+)ms/))&&(a=parseInt(a[1]),loadTimes.push(a),10<loadTimes.length&&loadTimes.shift(),n=loadTimes.reduce((e,t)=>e+t,0)/loadTimes.length,(l=document.getElementById("avgLoadTime"))&&(l.textContent=Math.round(n)+"ms"),console.log(`Load time recorded: ${a}ms, Average: ${Math.round(n)}ms`));var i=document.getElementById("log");if(i){var l=document.createElement("div"),a=(l.className="log-entry log-"+e,l.style.display="all"===currentLogFilter||currentLogFilter===e?"block":"none","error"===e?"❌":"warn"===e?"⚠️":"ℹ️");for(l.textContent=a+` [${r}] `+t,i.appendChild(l),i.scrollTop=i.scrollHeight;100<i.children.length;)i.removeChild(i.firstChild);updateLogStats(),updateEventChart()}}function updateLogStats(){var e=document.getElementById("totalLogs"),t=document.getElementById("infoCount"),n=document.getElementById("warnCount"),a=document.getElementById("errorCount");e&&(e.textContent=logCounts.info+logCounts.warn+logCounts.error),t&&(t.textContent=logCounts.info),n&&(n.textContent=logCounts.warn),a&&(a.textContent=logCounts.error)}function filterLogs(t){currentLogFilter=t,document.querySelectorAll(".log-entry").forEach(e=>{e.style.display="all"===t||e.classList.contains("log-"+t)?"block":"none"}),logEvent("info","로그 필터 변경: "+t)}function updateEventChart(){var e=document.getElementById("eventChart");if(e){const o=e.getContext("2d");var t=e.width;const i=e.height;o.clearRect(0,0,t,i);var n=new Date,a=[];for(let e=0;e<6;e++){const s=new Date(n.getTime()-1e4*(6-e)),c=new Date(n.getTime()-1e4*(5-e));var r=eventHistory.filter(e=>e.time>=s&&e.time<c);a.push({info:r.filter(e=>"info"===e.type).length,warn:r.filter(e=>"warn"===e.type).length,error:r.filter(e=>"error"===e.type).length})}const l=Math.max(...a.map(e=>e.info+e.warn+e.error),1),d=t/6;a.forEach((e,t)=>{var n,a,t=t*d;0<e.error&&(a=e.error/l*i,o.fillStyle="#dc3545",o.fillRect(2+t,i-a,d-4,a)),0<e.warn&&(a=e.warn/l*i,n=i-e.error/l*i-a,o.fillStyle="#ffc107",o.fillRect(2+t,n,d-4,a)),0<e.info&&(n=e.info/l*i,a=i-(e.error+e.warn+e.info)/l*i,o.fillStyle="#17a2b8",o.fillRect(2+t,a,d-4,n))})}}function clearLog(){document.getElementById("log").innerHTML="",logCounts={info:0,warn:0,error:0},eventHistory=[],totalStallCount=0,loadTimes=[],lastAdaptationTime=null,updateLogStats(),updateEventChart(),logEvent("info","로그 초기화 완료")}document.addEventListener("DOMContentLoaded",initializePlayer),window.addEventListener("beforeunload",()=>{statsInterval&&clearInterval(statsInterval),player&&player.destroy()});